<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý sản phẩm - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .sidebar {
      min-height: 100vh;
      background: rgb(90, 103, 170);
      color: white;
      padding: 20px 0;
    }
    .sidebar .nav-link {
      color: rgba(255,255,255,0.8);
      padding: 12px 20px;
      margin: 4px 10px;
      border-radius: 8px;
      transition: all 0.3s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background: #394867 !important;
      color: white;
    }
    .sidebar .nav-link i {
      width: 20px;
      margin-right: 10px;
    }
    .content-wrapper {
      padding: 30px;
    }
    .card {
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border-radius: 12px;
    }
    .table-actions .btn {
      padding: 4px 12px;
      font-size: 13px;
    }
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .product-image-preview {
      max-width: 80px;
      max-height: 80px;
      object-fit: cover;
      border-radius: 8px;
    }
    .badge-status {
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar">
        <div class="text-center mb-4">
          <h4 class="fw-bold">Admin Panel</h4>
          <small class="text-white-50">Quản lý hệ thống</small>
        </div>
        <nav class="nav flex-column">
          <a class="nav-link" href="/src/pages/admin/dashboard.html">
            <i class="fas fa-chart-line"></i> Dashboard
          </a>
          <a class="nav-link active" href="/src/pages/admin/product.html">
            <i class="fas fa-box"></i> Sản phẩm
          </a>
          <a class="nav-link" href="/src/pages/admin/category.html">
            <i class="fas fa-tags"></i> Danh mục
          </a>
          <a class="nav-link" href="/src/pages/admin/role.html">
            <i class="fas fa-shield-alt"></i> Vai trò
          </a>
          <a class="nav-link" href="/src/pages/admin/user.html">
            <i class="fas fa-users"></i> Người dùng
          </a>
          <a class="nav-link" href="/src/index.html">
            <i class="fas fa-home"></i> Trang chủ
          </a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="col-md-10 content-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="fw-bold mb-1">Quản lý sản phẩm</h2>
            <p class="text-muted mb-0">Quản lý danh sách sản phẩm trong hệ thống</p>
          </div>
          <button class="btn btn-primary" onclick="openCreateModal()">
            <i class="fas fa-plus me-2"></i>Thêm sản phẩm
          </button>
        </div>

        <!-- Search and Filter -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <input 
                  type="text" 
                  id="searchInput" 
                  class="form-control" 
                  placeholder="Tìm kiếm sản phẩm..."
                  onkeyup="handleSearch()"
                >
              </div>
              <div class="col-md-3">
                <select id="limitSelect" class="form-select" onchange="changeLimit()">
                  <option value="5">5 sản phẩm</option>
                  <option value="10" selected>10 sản phẩm</option>
                  <option value="20">20 sản phẩm</option>
                  <option value="50">50 sản phẩm</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                  <i class="fas fa-redo me-1"></i>Làm mới
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Products Table -->
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 5%">#</th>
                    <th style="width: 10%">Hình ảnh</th>
                    <th style="width: 25%">Tên sản phẩm</th>
                    <th style="width: 30%">Mô tả</th>
                    <th style="width: 10%">Giá</th>
                    <th style="width: 8%">Số lượng</th>
                    <th style="width: 12%" class="text-center">Thao tác</th>
                  </tr>
                </thead>
                <tbody id="productTableBody">
                  <tr>
                    <td colspan="7" class="text-center py-5">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="text-muted mt-2 mb-0">Đang tải dữ liệu...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-4">
              <div class="text-muted" id="paginationInfo">
                Hiển thị 0 - 0 trong tổng số 0 sản phẩm
              </div>
              <nav>
                <ul class="pagination mb-0" id="paginationControls">
                  <!-- Pagination buttons will be inserted here -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Product Modal -->
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thêm sản phẩm mới</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="productForm" onsubmit="handleFormSubmit(event)">
          <div class="modal-body">
            <input type="hidden" id="productId">
            <input type="hidden" id="isEditMode" value="false">

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="productName" class="form-label">
                  Tên sản phẩm <span class="text-danger">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="productName" 
                  required
                  minlength="1"
                  placeholder="Nhập tên sản phẩm"
                >
              </div>

              <div class="col-md-3 mb-3">
                <label for="productPrice" class="form-label">
                  Giá (VNĐ) <span class="text-danger">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-control" 
                  id="productPrice" 
                  required
                  min="0"
                  step="1000"
                  placeholder="0"
                >
              </div>

              <div class="col-md-3 mb-3">
                <label for="productQuantity" class="form-label">
                  Số lượng <span class="text-danger">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-control" 
                  id="productQuantity" 
                  required
                  min="0"
                  placeholder="0"
                >
              </div>
            </div>

            <div class="mb-3">
              <label for="productDescription" class="form-label">Mô tả</label>
              <textarea 
                class="form-control" 
                id="productDescription" 
                rows="4"
                placeholder="Nhập mô tả chi tiết về sản phẩm..."
              ></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>Hủy
            </button>
            <button type="submit" class="btn btn-primary" id="submitButton">
              <i class="fas fa-save me-1"></i>Lưu
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="/src/js/utils/toast.js"></script>
  <script src="/src/js/utils/storage.js"></script>
  <script src="/src/js/utils/auth.guard.js"></script>
  <script src="/src/js/utils/http.client.js"></script>
  <script src="/src/js/config/api.config.js"></script>
  <script src="/src/js/services/product.service.js"></script>

  <script>
    // Check admin authentication
    if (!AuthGuard.requireAdmin()) {
      // Will redirect automatically
    }

    // State management
    let currentPage = 1;
    let currentLimit = 10;
    let currentSearch = '';
    let totalPages = 0;
    let totalProducts = 0;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadProducts();
    });

    /**
     * Load products with pagination
     */
    async function loadProducts(page = 1) {
      currentPage = page;
      
      try {
        const { items, pagination } = await ProductService.list({
          page: String(currentPage),
          limit: String(currentLimit),
          search: currentSearch,
          includeDeleted: 'false'
        });

        if (pagination) {
          totalPages = pagination.totalPages || 1;
          totalProducts = pagination.total || 0;
        }

        renderProducts(items);
        renderPagination();
        updatePaginationInfo();

      } catch (error) {
        console.error('Load products error:', error);
        window.Toast?.error?.(error.message || 'Không thể tải danh sách sản phẩm');
        
        document.getElementById('productTableBody').innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-5">
              <i class="fas fa-exclamation-triangle text-warning fs-1 mb-3"></i>
              <p class="text-muted mb-0">${error.message || 'Có lỗi xảy ra khi tải dữ liệu'}</p>
            </td>
          </tr>
        `;
      }
    }

    /**
     * Render products table
     */
    function renderProducts(products) {
      const tbody = document.getElementById('productTableBody');
      
      // Filter out deleted products (workaround until backend fixes includeDeleted)
      const activeProducts = products.filter(p => !p.deletedAt);
      
      if (!activeProducts || activeProducts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-5">
              <i class="fas fa-inbox fs-1 text-muted mb-3"></i>
              <p class="text-muted mb-0">Không có sản phẩm nào</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = activeProducts.map((product, index) => {
        const rowNumber = (currentPage - 1) * currentLimit + index + 1;
        const primaryImage = product.images?.find(img => img.isPrimary)?.url || 
                           product.images?.[0]?.url || 
                           'https://via.placeholder.com/80x80?text=No+Image';
        
        const formattedPrice = new Intl.NumberFormat('vi-VN', {
          style: 'currency',
          currency: 'VND'
        }).format(product.price);

        const truncatedDescription = product.description && product.description.length > 50
          ? product.description.substring(0, 50) + '...'
          : product.description || '-';

        return `
          <tr>
            <td class="fw-bold">${rowNumber}</td>
            <td>
              <img src="${primaryImage}" alt="${product.name}" class="product-image-preview">
            </td>
            <td>
              <div class="fw-bold">${product.name}</div>
              <small class="text-muted">${product.slug || ''}</small>
            </td>
            <td>
              <small class="text-muted">${truncatedDescription}</small>
            </td>
            <td class="fw-bold text-success">${formattedPrice}</td>
            <td>
              <span class="badge ${product.quantity > 0 ? 'bg-success' : 'bg-danger'}">
                ${product.quantity}
              </span>
            </td>
            <td class="text-center table-actions">
              <button class="btn btn-sm btn-warning" onclick="openEditModal('${product.id}')" title="Chỉnh sửa">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')" title="Xóa">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    /**
     * Render pagination controls
     */
    function renderPagination() {
      const pagination = document.getElementById('paginationControls');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let html = '';

      // Previous button
      html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="loadProducts(${currentPage - 1}); return false;">
            <i class="fas fa-chevron-left"></i>
          </a>
        </li>
      `;

      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      if (startPage > 1) {
        html += `
          <li class="page-item">
            <a class="page-link" href="#" onclick="loadProducts(1); return false;">1</a>
          </li>
        `;
        if (startPage > 2) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadProducts(${i}); return false;">${i}</a>
          </li>
        `;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `
          <li class="page-item">
            <a class="page-link" href="#" onclick="loadProducts(${totalPages}); return false;">${totalPages}</a>
          </li>
        `;
      }

      // Next button
      html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="loadProducts(${currentPage + 1}); return false;">
            <i class="fas fa-chevron-right"></i>
          </a>
        </li>
      `;

      pagination.innerHTML = html;
    }

    /**
     * Update pagination info text
     */
    function updatePaginationInfo() {
      const start = (currentPage - 1) * currentLimit + 1;
      const end = Math.min(currentPage * currentLimit, totalProducts);
      
      document.getElementById('paginationInfo').textContent = 
        `Hiển thị ${start} - ${end} trong tổng số ${totalProducts} sản phẩm`;
    }

    /**
     * Handle search
     */
    let searchTimeout;
    function handleSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentSearch = document.getElementById('searchInput').value.trim();
        loadProducts(1); // Reset to page 1 when searching
      }, 500);
    }

    /**
     * Change items per page limit
     */
    function changeLimit() {
      currentLimit = parseInt(document.getElementById('limitSelect').value);
      loadProducts(1); // Reset to page 1
    }

    /**
     * Reset all filters
     */
    function resetFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('limitSelect').value = '10';
      currentSearch = '';
      currentLimit = 10;
      loadProducts(1);
    }

    /**
     * Open create product modal
     */
    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Thêm sản phẩm mới';
      document.getElementById('productForm').reset();
      document.getElementById('productId').value = '';
      document.getElementById('isEditMode').value = 'false';
      
      const modal = new bootstrap.Modal(document.getElementById('productModal'));
      modal.show();
    }

    /**
     * Open edit product modal
     */
    async function openEditModal(productId) {
      try {
        const product = await ProductService.getById(productId);
        
        document.getElementById('modalTitle').textContent = 'Chỉnh sửa sản phẩm';
        document.getElementById('productId').value = product.id;
        document.getElementById('isEditMode').value = 'true';
        document.getElementById('productName').value = product.name;
        document.getElementById('productDescription').value = product.description || '';
        document.getElementById('productPrice').value = product.price;
        document.getElementById('productQuantity').value = product.quantity;
        
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
        
      } catch (error) {
        console.error('Load product error:', error);
        window.Toast?.error?.(error.message || 'Không thể tải thông tin sản phẩm');
      }
    }

    /**
     * Handle form submit (create/update)
     */
    async function handleFormSubmit(event) {
      event.preventDefault();
      
      const submitButton = document.getElementById('submitButton');
      const originalText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang lưu...';

      try {
        const isEditMode = document.getElementById('isEditMode').value === 'true';
        const productId = document.getElementById('productId').value;
        
        const productData = {
          name: document.getElementById('productName').value.trim(),
          description: document.getElementById('productDescription').value.trim(),
          price: parseFloat(document.getElementById('productPrice').value),
          quantity: parseInt(document.getElementById('productQuantity').value)
        };

        if (isEditMode) {
          // Update product
          await ProductService.update(productId, productData);
          window.Toast?.success?.('Cập nhật sản phẩm thành công!');
        } else {
          // Create product
          await ProductService.create(productData);
          window.Toast?.success?.('Thêm sản phẩm mới thành công!');
        }

        // Close modal and reload list
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        loadProducts(currentPage);

      } catch (error) {
        console.error('Save product error:', error);
        window.Toast?.error?.(error.message || 'Không thể lưu sản phẩm');
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
      }
    }

    /**
     * Delete product
     */
    async function deleteProduct(productId) {
      if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
        return;
      }

      try {
        console.log('Deleting product:', productId);
        const result = await ProductService.delete(productId);
        console.log('Delete result:', result);
        
        window.Toast?.success?.('Xóa sản phẩm thành công!');
        
        // Force reload to ensure fresh data
        console.log('Reloading products...');
        await loadProducts(currentPage);
        
      } catch (error) {
        console.error('Delete product error:', error);
        window.Toast?.error?.(error.message || 'Không thể xóa sản phẩm');
      }
    }
  </script>
</body>
</html>
