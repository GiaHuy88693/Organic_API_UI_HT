<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Đăng nhập - Organic Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../../css/login.css">

  <!-- Toastify CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <style>
    body { background-color: #f0f2f5; font-family: 'Inter', sans-serif; }
    .login-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; flex-direction: column; }
    .login-logo { text-align: center; margin-bottom: 20px; }
    .login-card { background-color: #fff; border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); padding: 2rem 2.25rem; max-width: 440px; width: 100%; }
    .form-label, .form-check-label, .login-footer, .text-muted { font-size: 14px; }
    .login-btn { font-weight: 500; }
    .text-danger { font-size: 13px; }
    @media (max-width: 576px) {
      .login-wrapper { padding: 2.5rem 1rem; }
      .login-card { padding: 2rem 1.5rem; border-radius: 12px; }
      .login-logo img { max-width: 240px; margin-bottom: 1.5rem; }
      .form-label, .form-check-label { font-size: 1.15rem; font-weight: 500; }
      .form-control { font-size: 1.15rem; padding: 1rem 1.25rem; border-radius: 8px; }
      .btn.login-btn { font-size: 1.25rem; padding: 1rem; border-radius: 8px; }
      .login-footer { font-size: 1.05rem; margin-top: 1.5rem; }
    }
    /* Màu cho toast (tuỳ chọn) */
    .toast-success { background: #16a34a !important; }
    .toast-error   { background: #dc2626 !important; }
    .toast-info    { background: #2563eb !important; }
    .toast-warn    { background: #d97706 !important; }
  </style>
</head>
<body>
  <section class="login-wrapper">
    <div class="login-logo">
      <a href="/product">
        <img src="https://themewagon.github.io/organic/images/logo.svg" alt="Logo" />
      </a>
    </div>
    <div class="login-card">
      <form id="loginForm" novalidate>
        <!-- vẫn giữ alert để fallback, mặc định ẩn -->
        <div id="alertMessage" class="alert d-none text-center mt-2" role="alert"></div>

        <div class="mb-3">
          <label class="form-label">Email address</label>
          <input type="email" name="email" id="email" class="form-control" placeholder="Enter email" required />
          <div class="text-danger mt-1" id="emailError"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" name="password" id="password" class="form-control" placeholder="Enter password" required />
          <div class="text-danger mt-1" id="passwordError"></div>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="rememberMe" />
          <label class="form-check-label" for="rememberMe">Remember me</label>
        </div>

        <button type="submit" class="btn btn-primary w-100 login-btn" id="btnLogin">
          Đăng nhập
          <span class="spinner-border spinner-border-sm ms-2 d-none" id="loginSpinner"></span>
        </button>

        <div class="text-center mt-3 mb-2">
          <a href="forgot-password.html" class="text-decoration-none">Forgot Password?</a>
        </div>

        <div class="login-footer mt-2">
          Chưa có tài khoản? <a href="register.html">Đăng ký ngay</a>
        </div>
      </form>
    </div>
  </section>

  <!-- Toastify JS -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- Import JS files -->
  <script src="../../js/config/api.config.js"></script>
  <script src="../../js/utils/storage.js"></script>
  <script src="../../js/utils/http.client.js"></script>
  <script src="../../js/services/auth.service.js"></script>

  <script>
    // Toast helper
    function toast(message, type = 'info') {
      Toastify({
        text: message || '',
        duration: 3500,
        gravity: 'top',
        position: 'right',
        close: true,
        stopOnFocus: true,
        className: `toast-${type}`
      }).showToast();
    }

    // Fallback alert (giữ lại nhưng ưu tiên Toastify)
    function showAlert(message, type = 'danger') {
      const el = document.getElementById('alertMessage');
      el.textContent = message;
      el.className = `alert alert-${type} text-center mt-2`;
      el.classList.remove('d-none');
      setTimeout(() => { el.classList.add('d-none'); }, 5000);
    }

    // Field errors
    function showFieldError(fieldId, message) {
      const errorEl = document.getElementById(fieldId + 'Error');
      const inputEl = document.getElementById(fieldId);
      errorEl.textContent = message || '';
      inputEl.classList.add('is-invalid');
    }

    function clearErrors() {
      ['email', 'password'].forEach(id => {
        document.getElementById(id + 'Error').textContent = '';
        document.getElementById(id).classList.remove('is-invalid');
      });
    }

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      clearErrors();
      document.getElementById('alertMessage').classList.add('d-none');

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const btnLogin = document.getElementById('btnLogin');
      const spinner = document.getElementById('loginSpinner');

      let hasError = false;
      if (!email) {
        showFieldError('email', 'Vui lòng nhập email');
        hasError = true;
      }
      if (!password) {
        showFieldError('password', 'Vui lòng nhập mật khẩu');
        hasError = true;
      }
      if (hasError) return;

      btnLogin.disabled = true;
      spinner.classList.remove('d-none');

      try {
        // Gọi service login (service phải trả { success, message, errors, data })
        const result = await AuthService.login(email, password);

        if (result.success) {
          // Message thành công lấy từ backend
          toast(result.message || 'Đăng nhập thành công', 'success');

          // Redirect home sau 900ms (cho user thấy toast)
          setTimeout(() => {
            window.location.href = '../../index.html'; // đổi sang trang home của bạn nếu khác
          }, 900);
          return;
        }

        // Thất bại: hiển thị đúng message từ backend
        if (result.message) {
          toast(result.message, 'error');
        } else {
          toast('Đăng nhập thất bại', 'error');
        }

        // Hiển thị từng lỗi field từ backend (nếu có)
        if (Array.isArray(result.errors)) {
          result.errors.forEach(err => {
            const field = err?.field || err?.path || '';
            const msg   = err?.message || '';
            if (field === 'email') showFieldError('email', msg);
            if (field === 'password') showFieldError('password', msg);
            if (!field) toast(msg, 'error'); // lỗi chung
          });
        }

      } catch (error) {
        console.error('Login error:', error);
        toast('Có lỗi xảy ra. Vui lòng thử lại sau.', 'error');
        showAlert('Có lỗi xảy ra. Vui lòng thử lại sau.', 'danger'); // fallback
      } finally {
        btnLogin.disabled = false;
        spinner.classList.add('d-none');
      }
    });

    // Nếu đã đăng nhập thì vào thẳng home
    if (typeof Storage !== 'undefined' && Storage.isAuthenticated && Storage.isAuthenticated()) {
      window.location.href = '../../index.html';
    }
  </script>
  
</body>
</html>
